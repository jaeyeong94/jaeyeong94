name: Update Featured Projects

on:
  schedule:
    - cron: "0 1 * * *" # ë§¤ì¼ UTC 01:00 (í•œêµ­ì‹œê°„ 10:00)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Update README with featured projects
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          
          # ìµœê·¼ pushëœ public ë¦¬í¬ 3ê°œ ê°€ì ¸ì˜¤ê¸° (í”„ë¡œí•„ ë¦¬í¬ ì œì™¸)
          repos_json=$(gh repo list $OWNER \
            --json name,isPrivate,pushedAt,primaryLanguage,description \
            --jq "[.[] | select(.isPrivate == false and .name != \"$OWNER\")] | sort_by(.pushedAt) | reverse | .[0:3]")
          
          # ì„ì‹œ íŒŒì¼ì— í…Œì´ë¸” ì‘ì„±
          echo "## ğŸš€ ì£¼ìš” í”„ë¡œì íŠ¸" > /tmp/featured.md
          echo "" >> /tmp/featured.md
          echo "| í”„ë¡œì íŠ¸ | ê¸°ìˆ  | ì„¤ëª… |" >> /tmp/featured.md
          echo "|---------|------|------|" >> /tmp/featured.md
          
          echo "$repos_json" | jq -c '.[]' | while read -r repo; do
            name=$(echo "$repo" | jq -r '.name')
            lang=$(echo "$repo" | jq -r '.primaryLanguage.name // "Code"')
            desc=$(echo "$repo" | jq -r '.description // "ì„¤ëª… ì—†ìŒ"')
            
            # ì–¸ì–´ë³„ ë°°ì§€
            case "$lang" in
              "TypeScript") badge="![TypeScript](https://img.shields.io/badge/-TypeScript-3178C6?style=flat-square&logo=typescript&logoColor=white)" ;;
              "JavaScript") badge="![JavaScript](https://img.shields.io/badge/-JavaScript-F7DF1E?style=flat-square&logo=javascript&logoColor=black)" ;;
              "Python") badge="![Python](https://img.shields.io/badge/-Python-3776AB?style=flat-square&logo=python&logoColor=white)" ;;
              "Rust") badge="![Rust](https://img.shields.io/badge/-Rust-000000?style=flat-square&logo=rust&logoColor=white)" ;;
              "Shell") badge="![Shell](https://img.shields.io/badge/-Shell-4EAA25?style=flat-square&logo=gnu-bash&logoColor=white)" ;;
              "Vue") badge="![Vue](https://img.shields.io/badge/-Vue-4FC08D?style=flat-square&logo=vue.js&logoColor=white)" ;;
              "MDX") badge="![MDX](https://img.shields.io/badge/-MDX-1B1F24?style=flat-square&logo=mdx&logoColor=white)" ;;
              "Go") badge="![Go](https://img.shields.io/badge/-Go-00ADD8?style=flat-square&logo=go&logoColor=white)" ;;
              *) badge="![Code](https://img.shields.io/badge/-Code-333333?style=flat-square&logo=github&logoColor=white)" ;;
            esac
            
            echo "| [$name](https://github.com/$OWNER/$name) | $badge | $desc |" >> /tmp/featured.md
          done
          
          # READMEì—ì„œ Featured Projects ì„¹ì…˜ êµì²´
          awk '
            /^## ğŸš€ ì£¼ìš” í”„ë¡œì íŠ¸/ { skip = 1; next }
            /^---$/ && skip { skip = 0; next }
            /^## / && skip { skip = 0 }
            !skip { print }
          ' README.md > /tmp/readme_without_featured.md
          
          # ì„¹ì…˜ ì‚½ì… ìœ„ì¹˜ ì°¾ê¸° (ê¸°ì—¬ ê·¸ë˜í”„ ì „)
          awk '
            /^## ğŸ“ˆ ê¸°ì—¬ ê·¸ë˜í”„/ {
              system("cat /tmp/featured.md")
              print ""
              print "---"
              print ""
            }
            { print }
          ' /tmp/readme_without_featured.md > README.md
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "ğŸ”„ ì£¼ìš” í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸"
          git push
