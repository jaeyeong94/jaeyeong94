name: Update Featured Projects

on:
  schedule:
    - cron: "0 1 * * *" # Îß§Ïùº UTC 01:00 (ÌïúÍµ≠ÏãúÍ∞Ñ 10:00)
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Update README with featured projects
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          
          # ÏµúÍ∑º pushÎêú public Î¶¨Ìè¨ 3Í∞ú Í∞ÄÏ†∏Ïò§Í∏∞ (ÌîÑÎ°úÌïÑ Î¶¨Ìè¨ Ï†úÏô∏)
          repos_json=$(gh repo list $OWNER \
            --json name,isPrivate,pushedAt,primaryLanguage,description \
            --jq "[.[] | select(.isPrivate == false and .name != \"$OWNER\")] | sort_by(.pushedAt) | reverse | .[0:3]")
          
          # Ïñ∏Ïñ¥Î≥Ñ Î∞∞ÏßÄ ÏÉâÏÉÅ Îß§Ìïë
          get_badge() {
            local lang="$1"
            case "$lang" in
              "TypeScript") echo "![TypeScript](https://img.shields.io/badge/-TypeScript-3178C6?style=flat-square&logo=typescript&logoColor=white)" ;;
              "JavaScript") echo "![JavaScript](https://img.shields.io/badge/-JavaScript-F7DF1E?style=flat-square&logo=javascript&logoColor=black)" ;;
              "Python") echo "![Python](https://img.shields.io/badge/-Python-3776AB?style=flat-square&logo=python&logoColor=white)" ;;
              "Rust") echo "![Rust](https://img.shields.io/badge/-Rust-000000?style=flat-square&logo=rust&logoColor=white)" ;;
              "Shell") echo "![Shell](https://img.shields.io/badge/-Shell-4EAA25?style=flat-square&logo=gnu-bash&logoColor=white)" ;;
              "Vue") echo "![Vue](https://img.shields.io/badge/-Vue-4FC08D?style=flat-square&logo=vue.js&logoColor=white)" ;;
              "MDX") echo "![MDX](https://img.shields.io/badge/-MDX-1B1F24?style=flat-square&logo=mdx&logoColor=white)" ;;
              "Go") echo "![Go](https://img.shields.io/badge/-Go-00ADD8?style=flat-square&logo=go&logoColor=white)" ;;
              *) echo "![Code](https://img.shields.io/badge/-Code-333333?style=flat-square&logo=github&logoColor=white)" ;;
            esac
          }
          
          # ÌÖåÏù¥Î∏î Ìó§Îçî
          TABLE="## üöÄ Featured Projects\n\n| Project | Tech | Description |\n|---------|------|-------------|"
          
          # Í∞Å Î¶¨Ìè¨ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
          while IFS= read -r repo; do
            name=$(echo "$repo" | jq -r '.name')
            lang=$(echo "$repo" | jq -r '.primaryLanguage.name // "Code"')
            desc=$(echo "$repo" | jq -r '.description // "No description"')
            badge=$(get_badge "$lang")
            TABLE="$TABLE\n| [$name](https://github.com/$OWNER/$name) | $badge | $desc |"
          done < <(echo "$repos_json" | jq -c '.[]')
          
          # READMEÏóêÏÑú Featured Projects ÏÑπÏÖò ÍµêÏ≤¥
          awk -v table="$TABLE" '
            /^## üöÄ Featured Projects/ { 
              printf "%b\n", table
              skip = 1
              next
            }
            /^---$/ && skip { skip = 0 }
            /^## / && skip { skip = 0 }
            !skip { print }
          ' README.md > README.tmp && mv README.tmp README.md
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "üîÑ Update featured projects"
          git push
