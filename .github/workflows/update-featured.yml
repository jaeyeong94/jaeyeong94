name: Update Featured Projects

on:
  schedule:
    - cron: "0 1 * * *" # ë§¤ì¼ UTC 01:00 (í•œêµ­ì‹œê°„ 10:00)
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get recent public repos
        id: repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ìµœê·¼ pushëœ public ë¦¬í¬ 3ê°œ ê°€ì ¸ì˜¤ê¸° (í”„ë¡œí•„ ë¦¬í¬ ì œì™¸)
          repos=$(gh repo list ${{ github.repository_owner }} \
            --json name,isPrivate,pushedAt \
            --jq '[.[] | select(.isPrivate == false and .name != "${{ github.repository_owner }}")] | sort_by(.pushedAt) | reverse | .[0:3] | .[].name')
          
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          echo "$repos" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update README
        run: |
          REPOS="${{ steps.repos.outputs.repos }}"
          OWNER="${{ github.repository_owner }}"
          
          # Featured Projects ì„¹ì…˜ ìƒì„±
          FEATURED="## ğŸš€ Featured Projects\n\n<p align=\"center\">"
          
          for repo in $REPOS; do
            FEATURED="$FEATURED\n  <a href=\"https://github.com/$OWNER/$repo\">"
            FEATURED="$FEATURED\n    <img src=\"https://github-readme-stats-sigma-five.vercel.app/api/pin/?username=$OWNER&repo=$repo&theme=tokyonight&hide_border=true&bg_color=0D1117&title_color=6366F1&icon_color=6366F1\"/>"
            FEATURED="$FEATURED\n  </a>"
          done
          
          FEATURED="$FEATURED\n</p>"
          
          # READMEì—ì„œ Featured Projects ì„¹ì…˜ êµì²´
          awk -v featured="$FEATURED" '
            /^## ğŸš€ Featured Projects/ { 
              print featured
              skip = 1
              next
            }
            /^---$/ && skip { skip = 0 }
            /^## / && skip { skip = 0 }
            !skip { print }
          ' README.md > README.tmp && mv README.tmp README.md
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "ğŸ”„ Update featured projects"
          git push
